#!/usr/bin/env fish

set branchName (git branch --show-current 2> /dev/null)
set projectRoot (git rev-parse --show-toplevel 2> /dev/null)

begin
  test "$projectRoot" != ""
  and set p $projectRoot
  or set p $PWD
  string replace -r '^'"$HOME"'($|/)' '~$1' $p | string replace -ar '(\.?[^/]{1})[^/]*/' '$1/'

  test "$branchName" != ""
  and echo "($branchName)"

  test "$projectRoot" != ""
  and test "$projectRoot" != $PWD
  and string replace $projectRoot '' $PWD | string replace -r '^'"$HOME"'($|/)' '~$1' | string replace -ar '(\.?[^/]{1})[^/]*/' '$1/'
end > $argv[1]

set --query argv[2]
and kill -WINCH $argv[2]

exit 0
