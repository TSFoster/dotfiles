#!/usr/bin/env zsh

# To get lua working with Homebrew on Mac, I had to link lua.h in the Cellar to /usr/include
# To get ruby and python working dynamically, I had to install them with:
# {RUBY,PYTHON}_CONFIGURE_OPTS='--enable-shared' {rb,py}env install x.y.z

set -e

VIM_REPO=$HOME/.vimrepo

MYLDFLAGS=(
  -Wl,-rpath,"$(pyenv prefix)/lib"
  -Wl,-rpath,"$(rbenv prefix)/lib"
)

if ! [ -d "$VIM_REPO" ]; then
  hg clone https://vim.googlecode.com/hg/ $VIM_REPO
fi

cd $VIM_REPO
hg pull -u

make distclean
./configure             \
  --with-features=huge   \
  --enable-luainterp=yes  \
  --enable-rubyinterp=dynamic  \
  --enable-pythoninterp=dynamic \
  --with-python-config-dir=$(pyenv prefix)/lib/python2.7/config \
  LDFLAGS="$MYLDFLAGS"
make && make install
